# ai-story-weaver â€“ Next.jsÂ 14 (AppÂ Router)

> **v0.2 â€“ now with full pictureâ€‘book metadata & interaction**

---
## ğŸ—‚Â Project structure (new/changedÂ â˜…)
```
app/
â”œâ”€ layout.tsx
â”œâ”€ page.tsx                â€¢ generator home
â”œâ”€ story/[id]/page.tsx â˜…    â€¢ share / view page (URLâ€‘encoded data)
â”œâ”€ saved/page.tsx â˜…         â€¢ local bookmarks
â”‚
â”œâ”€ api/
â”‚   â””â”€ story/route.ts       â€¢ GPT endpoint (prompt now accepts options)
â”‚
components/
â”œâ”€ KeywordInput.tsx
â”œâ”€ AdvancedOptions.tsx â˜…    â€¢ Tone / Length / Age / Title / Moral
â”œâ”€ StoryMeta.tsx â˜…          â€¢ Title (editable) + author + readingâ€‘time + moral + TTS + share + save
â”œâ”€ StoryDisplay.tsx         â€¢ paged paragraphs
â””â”€ SavedStories.tsx â˜…       â€¢ grid of local stories
lib/
â””â”€ openai.ts
utils/
â””â”€ helpers.ts â˜…             â€¢ readingTime(), encode(), decode()
```

---
## README.md (excerpt)
```md
###Â âœ¨Â New v0.2 Features
* **Title / Moral sentence** autoâ€‘generated, editable inline.
* **AdvancedÂ Options** â€“ pick ToneÂ (fun / adventure / bedtime), LengthÂ (200â€‘500 words), Age RangeÂ (3â€‘5Â /Â 6â€‘8 yrs).
* **Readingâ€‘time badge** (wordÂ count Ã·Â 150Â wpm).
* **Speech (TTS)** â€“ Chrome/Edge/Firefox via `window.speechSynthesis`.
* **Save & Share** â€“ oneâ€‘click bookmark toÂ browser, and permalink `/story/<b64>`.
```

---
## utils/helpers.ts
```ts
export function readingTime(words: number) {
  return Math.ceil(words / 150);
}

export function encode(data: object) {
  return Buffer.from(JSON.stringify(data)).toString("base64url");
}
export function decode<T>(b64: string): T {
  return JSON.parse(Buffer.from(b64, "base64url").toString());
}
```

---
## components/AdvancedOptions.tsx
```tsx
"use client";
import { useState } from "react";
const tones = ["fun", "adventure", "bedtime", "science"];
export default function AdvancedOptions({ onChange }: { onChange: (o: any) => void }) {
  const [open, setOpen] = useState(false);
  const [opts, setOpts] = useState({ tone: "fun", length: 300, age: "3-5", title: "", moral: "" });
  function update(field: string, value: any) {
    const next = { ...opts, [field]: value };
    setOpts(next);
    onChange(next);
  }
  return (
    <div className="my-4">
      <button className="text-sm underline" onClick={() => setOpen(!open)}>
        {open ? "â–² éš±è—é€²éšé¸é …" : "â–¼ é¡¯ç¤ºé€²éšé¸é …"}
      </button>
      {open && (
        <div className="mt-4 grid gap-3">
          <div>
            <label className="block text-xs mb-1">è‡ªè¨‚æ¨™é¡Œ</label>
            <input value={opts.title} onChange={e => update("title", e.target.value)} className="rounded p-2 w-full" />
          </div>
          <div>
            <label className="block text-xs mb-1">Tone / é¢¨æ ¼</label>
            <select value={opts.tone} onChange={e => update("tone", e.target.value)} className="rounded p-2 w-full">
              {tones.map(t => <option key={t}>{t}</option>)}
            </select>
          </div>
          <div className="flex gap-3">
            <div className="flex-1">
              <label className="block text-xs mb-1">æ•…äº‹é•·åº¦</label>
              <select value={opts.length} onChange={e => update("length", +e.target.value)} className="rounded p-2 w-full">
                {[200,300,400,500].map(n => <option key={n} value={n}>{n} å­—</option>)}
              </select>
            </div>
            <div className="flex-1">
              <label className="block text-xs mb-1">é©è®€å¹´é½¡</label>
              <select value={opts.age} onChange={e => update("age", e.target.value)} className="rounded p-2 w-full">
                <option value="3-5">3â€“5 æ­²</option>
                <option value="6-8">6â€“8 æ­²</option>
              </select>
            </div>
          </div>
          <div>
            <label className="block text-xs mb-1">ä¸»é¡Œå¥ / Moral (å¯ç©ºç™½)</label>
            <input value={opts.moral} onChange={e => update("moral", e.target.value)} className="rounded p-2 w-full" />
          </div>
        </div>
      )}
    </div>
  );
}
```

---
## components/StoryMeta.tsx
```tsx
"use client";
import { useState } from "react";
import { readingTime, encode } from "@/utils/helpers";

type Props = { story: string; meta: any };
export default function StoryMeta({ story, meta }: Props) {
  const [title, setTitle] = useState(meta.title || "Untitled Story");
  const words = story.trim().split(/\s+/).length;
  const minutes = readingTime(words);

  function speak() {
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(`${title}. ${story}`);
    utter.lang = meta.lang === "zh" ? "zh-TW" : "en-US";
    window.speechSynthesis.speak(utter);
  }
  function share() {
    const url = `${location.origin}/story/${encode({ ...meta, title, story })}`;
    navigator.clipboard.writeText(url);
    alert("å·²è¤‡è£½åˆ†äº«é€£çµï¼");
  }
  function save() {
    const list = JSON.parse(localStorage.getItem("stories") || "[]");
    list.unshift({ ...meta, title, story, ts: Date.now() });
    localStorage.setItem("stories", JSON.stringify(list.slice(0, 20)));
    alert("å·²åŠ å…¥æ”¶è—");
  }
  return (
    <div className="bg-white/80 p-4 rounded-2xl shadow mt-6">
      <input
        value={title}
        onChange={e => setTitle(e.target.value)}
        className="text-xl font-bold mb-2 w-full bg-transparent focus:outline-none"
      />
      <p className="text-sm opacity-70 mb-2">ä½œè€…ï¼šAI Story Weaver âœ¦ é–±è®€æ™‚é–“ï¼šç´„ {minutes} åˆ†é˜</p>
      {meta.moral && <p className="italic mb-2">â˜… {meta.moral}</p>}
      <div className="flex gap-3 text-sm">
        <button onClick={speak} className="underline">ğŸ”Š æœ—è®€</button>
        <button onClick={share} className="underline">ğŸ”— åˆ†äº«</button>
        <button onClick={save} className="underline">â˜… æ”¶è—</button>
      </div>
    </div>
  );
}
```

---
## components/StoryDisplay.tsx  (minor update)
```tsx
import { useState } from "react";
export default function StoryDisplay({ story }: { story: string }) {
  if (!story) return null;
  const paragraphs = story.split(/\n+/);
  const [page, setPage] = useState(0);
  return (
    <article className="mt-4 bg-white/70 backdrop-blur p-6 rounded-2xl shadow relative">
      <p className="leading-7 whitespace-pre-wrap">{paragraphs[page]}</p>
      {paragraphs.length > 1 && (
        <div className="flex justify-between mt-4 text-sm">
          <button disabled={page===0} onClick={()=>setPage(p=>p-1)} className="opacity-70">â† Prev</button>
          <span>{page+1}/{paragraphs.length}</span>
          <button disabled={page===paragraphs.length-1} onClick={()=>setPage(p=>p+1)} className="opacity-70">Next â†’</button>
        </div>
      )}
    </article>
  );
}
```

---
## components/SavedStories.tsx
```tsx
"use client";
import Link from "next/link";
import { encode } from "@/utils/helpers";
export default function SavedStories() {
  const list = typeof window !== "undefined" ? JSON.parse(localStorage.getItem("stories") || "[]") : [];
  if (!list.length) return <p>å°šç„¡æ”¶è—ã€‚</p>;
  return (
    <div className="grid gap-4">
      {list.map((s:any,i:number)=>(
        <Link key={i} href={`/story/${encode(s)}`} className="p-4 bg-white/60 rounded-xl hover:bg-white/80 transition">
          <h3 className="font-bold">{s.title}</h3>
          <p className="text-xs opacity-70 line-clamp-2">{s.story}</p>
        </Link>
      ))}
    </div>
  );
}
```

---
## app/page.tsx (replaced)
```tsx
import { useState } from "react";
import KeywordInput from "@/components/KeywordInput";
import AdvancedOptions from "@/components/AdvancedOptions";
import StoryMeta from "@/components/StoryMeta";
import StoryDisplay from "@/components/StoryDisplay";

export default function Home() {
  const [story, setStory] = useState("");
  const [meta, setMeta] = useState<any>({});
  const [loading, setLoading] = useState(false);

  const generate = async (keywords: string[], lang: string, opts: any) => {
    if (!keywords.length) return;
    setLoading(true);
    const res = await fetch("/api/story", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ keywords, lang, opts }),
    });
    const data = await res.json();
    setStory(data.story);
    setMeta({ lang, ...opts });
    setLoading(false);
  };

  const [advOpts, setAdvOpts] = useState<any>({ tone:"fun", length:300, age:"3-5", title:"", moral:"" });

  return (
    <section>
      <KeywordInput onGenerate={(k,l)=>generate(k,l,advOpts)} />
      <AdvancedOptions onChange={setAdvOpts} />
      {loading && <p className="mt-6 animate-pulse">æ•…äº‹ç”Ÿæˆä¸­â€¦</p>}
      {story && <StoryMeta story={story} meta={meta} />}
      <StoryDisplay story={story} />
    </section>
  );
}
```

---
## app/api/story/route.ts (prompt upgrade)
```ts
import { NextRequest, NextResponse } from "next/server";
import { createOpenAI } from "@/lib/openai";
export const runtime = "edge";

export async function POST(req: NextRequest) {
  const { keywords, lang, opts } = await req.json();
  const kw = (keywords as string[]).filter(Boolean).slice(0,5);
  const language = lang === "random" ? (Math.random()<0.5?"zh":"en") : lang;

  const toneDesc = {
    fun: language==="zh"?"æ´»æ½‘æœ‰è¶£":"fun and lively",
    adventure: language==="zh"?"å†’éšªåˆºæ¿€":"full of adventure",
    bedtime: language==="zh"?"æº«æŸ”çš„ç¡å‰èªæ°£":"gentle bedtime tone",
    science: language==="zh"?"å¸¶ç§‘å­¸å°çŸ¥è­˜":"sprinkled with science facts",
  }[opts.tone];

  const system = language==="zh"
    ? `ä½ æ˜¯ä¸€ä½å…’ç«¥æ•…äº‹ä½œå®¶ï¼Œå°è±¡ 3â€‘8 æ­²ï¼Œä»¥${toneDesc}å¯« ${opts.length} å­—ä¸­æ–‡æ•…äº‹ã€‚`
    : `You are a kids' storyteller (age 3â€‘8). Write a ${toneDesc} story of ${opts.length} English words.`;

  const user = language==="zh"
    ? `é—œéµå­—ï¼š${kw.join("ã€")}`
    : `Keywords: ${kw.join(", ")}`;

  const openai = createOpenAI();
  const completion = await openai.chat.completions.create({
    model:"gpt-4o-mini",
    temperature:0.9,
    max_tokens: Math.round(opts.length*2),
    messages:[{role:"system",content:system},{role:"user",content:user}]
  });

  const raw = completion.choices[0].message.content || "";
  // quick parse: first line title, last line moral if detect "Moral:" / "å¯“æ„ï¼š"
  let title="", moral="";
  const lines = raw.split(/\n+/);
  if(lines[0].length<50) { title = lines.shift()!; }
  if(/^(Moral|å¯“æ„)ï¼š/.test(lines[lines.length-1])) { moral = lines.pop()!.replace(/^(Moral|å¯“æ„)ï¼š/,''); }
  const story = lines.join("\n\n");

  return NextResponse.json({ story, title, moral });
}
```

---
## app/story/[id]/page.tsx
```tsx
import { decode } from "@/utils/helpers";
import StoryMeta from "@/components/StoryMeta";
import StoryDisplay from "@/components/StoryDisplay";

export default function StoryPage({ params }: { params: { id: string } }) {
  const data = decode<any>(params.id);
  return (
    <div>
      <StoryMeta story={data.story} meta={data} />
      <StoryDisplay story={data.story} />
    </div>
  );
}
```

---
## app/saved/page.tsx
```tsx
import SavedStories from "@/components/SavedStories";
export const metadata = { title: "å·²æ”¶è—æ•…äº‹ | AI Story Weaver" };
export default function Saved() { return <SavedStories/>; }
```

---
ğŸ’¡ **All core files now include the new elements.**  Build & deploy as before; no extra dependencies required.
