# ai-story-weaver â€“ Next.js 14 (App Router)

> **v0.4 â€“ Role/Scene Selector â€¢ Choice Branch â€¢ Achievements bar**

---
## æ–°å¢/ä¿®æ”¹æª”æ¡ˆ
```
app/
â”œâ”€ page.tsx                 # Home âœ Playground flows
â”œâ”€ api/
â”‚   â”œâ”€ story/route.ts        # unchanged
â”‚   â””â”€ branch/route.ts       # â˜… new â€“ continue story based on choice
components/
â”œâ”€ RoleScenePanel.tsx        # â˜… new â€“ replace KeywordInput
â”œâ”€ GeneratePanel.tsx         # â˜… new â€“ story/music buttons
â”œâ”€ ChoiceBranch.tsx          # â˜… new â€“ inline branch buttons
â”œâ”€ AchievementsBar.tsx       # â˜… new â€“ saved stickers
â”œâ”€ KeywordInput.tsx          # kept for fallback
â””â”€ ... (others unchanged)
```

---
## components/RoleScenePanel.tsx
```tsx
"use client";
import { useState } from "react";

const roles = ["ç‹å­", "å…¬ä¸»", "çŸ®äºº", "ç²¾éˆ", "ç¨è§’ç¸", "å¥³å·«"];
const scenes = ["æ£®æ—", "åŸå ¡", "æµ·æ´‹", "å¤ªç©º"];

export default function RoleScenePanel({ onReady }: { onReady: (roles: string[], scene: string) => void }) {
  const [selRoles, setSelRoles] = useState<string[]>([]);
  const [scene, setScene] = useState("");

  function toggleRole(r: string) {
    setSelRoles((arr) =>
      arr.includes(r) ? arr.filter((x) => x !== r) : arr.length < 3 ? [...arr, r] : arr
    );
  }
  return (
    <div className="space-y-4 p-4 bg-white/70 rounded-2xl shadow">
      <h3 className="font-bold">é¸è§’è‰² (æœ€å¤š 3)</h3>
      <div className="flex flex-wrap gap-2">
        {roles.map((r) => (
          <button
            key={r}
            onClick={() => toggleRole(r)}
            className={`px-3 py-1 rounded-full border ${selRoles.includes(r) ? "bg-brandYellow" : "bg-white"}`}
          >
            {r}
          </button>
        ))}
      </div>

      <h3 className="font-bold mt-4">é¸å ´æ™¯</h3>
      <div className="flex gap-2">
        {scenes.map((s) => (
          <button
            key={s}
            onClick={() => setScene(s)}
            className={`px-3 py-1 rounded-full border ${scene === s ? "bg-brandYellow" : "bg-white"}`}
          >
            {s}
          </button>
        ))}
      </div>

      <button
        disabled={!selRoles.length || !scene}
        onClick={() => onReady(selRoles, scene)}
        className="mt-4 w-full bg-brandYellow font-bold py-2 rounded-xl disabled:opacity-40"
      >
        ä¸‹ä¸€æ­¥ â†’
      </button>
    </div>
  );
}
```

---
## components/GeneratePanel.tsx
```tsx
"use client";
export default function GeneratePanel({ onStory }: { onStory: () => void }) {
  return (
    <div className="flex gap-4 mt-6">
      <button onClick={onStory} className="flex-1 bg-brandYellow py-2 rounded-xl font-bold shadow">
        ç”Ÿæˆæ•…äº‹
      </button>
      {/* é ç•™éŸ³æ¨‚ */}
      {/* <button disabled className="flex-1 bg-gray-300 py-2 rounded-xl font-bold opacity-60">ç”ŸæˆéŸ³æ¨‚</button> */}
    </div>
  );
}
```

---
## components/ChoiceBranch.tsx
```tsx
"use client";
export default function ChoiceBranch({ options, onPick }: { options: string[]; onPick: (c: string) => void }) {
  if (!options.length) return null;
  return (
    <div className="mt-4 flex gap-4">
      {options.map((o) => (
        <button key={o} onClick={() => onPick(o)} className="flex-1 bg-brandYellow py-2 rounded-xl font-bold">
          {o}
        </button>
      ))}
    </div>
  );
}
```

---
## components/AchievementsBar.tsx
```tsx
"use client";
import { useEffect, useState } from "react";
export default function AchievementsBar() {
  const [badges, setBadges] = useState<string[]>([]);
  useEffect(() => {
    const arr = JSON.parse(localStorage.getItem("badges") || "[]");
    setBadges(arr);
  }, []);
  if (!badges.length) return null;
  return (
    <div className="fixed bottom-4 right-4 bg-white/80 rounded-full shadow px-4 py-2 flex gap-2 text-xl">
      {badges.map((b, i) => (
        <span key={i}>{b}</span>
      ))}
    </div>
  );
}
```

---
## app/api/branch/route.ts
```ts
import { NextRequest, NextResponse } from "next/server";
import { createOpenAI } from "@/lib/openai";
export const runtime = "edge";

export async function POST(req: NextRequest) {
  const { storySoFar, choice } = await req.json();
  const openai = createOpenAI();
  const completion = await openai.chat.completions.create({
    model: "gpt-4o-mini",
    temperature: 0.9,
    max_tokens: 200,
    messages: [
      { role: "system", content: "ä½ æ˜¯ä¸€ä½å…’ç«¥æ•…äº‹æ¥é¾ä½œå®¶ï¼Œå»¶çºŒå·²æœ‰æ•…äº‹ä¸¦æ ¹æ“šå­©å­çš„é¸æ“‡çµ¦å‡ºä¸‹ä¸€æ®µï¼Œæœ€å¾Œä¸è¦ç¸½çµä¹Ÿä¸è¦èªªå®Œçµã€‚" },
      { role: "user", content: `å·²æœ‰æ•…äº‹ï¼š${storySoFar}\nå­©å­é¸æ“‡ï¼š${choice}\nè«‹çºŒå¯« 1 æ®µã€‚` },
    ],
  });
  return NextResponse.json({ nextPart: completion.choices[0].message.content });
}
```

---
## app/page.tsx (é—œéµç‰‡æ®µ)
```tsx
import { useState } from "react";
import HeroSection from "@/components/HeroSection";
import FeaturesSection from "@/components/FeaturesSection";
import RoleScenePanel from "@/components/RoleScenePanel";
import GeneratePanel from "@/components/GeneratePanel";
import StoryMeta from "@/components/StoryMeta";
import StoryDisplay from "@/components/StoryDisplay";
import ChoiceBranch from "@/components/ChoiceBranch";
import AchievementsBar from "@/components/AchievementsBar";

export default function Home() {
  const [roles, setRoles] = useState<string[]>([]);
  const [scene, setScene] = useState("");
  const [story, setStory] = useState("");
  const [meta, setMeta] = useState<any>({});
  const [branchOpts, setBranchOpts] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);

  const generateStory = async () => {
    setLoading(true);
    const res = await fetch("/api/story", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ keywords: [...roles, scene], lang: "zh", opts: { tone: "fun", length: 300, age: "3-5", title: "", moral: "" } }),
    });
    const data = await res.json();
    setStory(data.story);
    setMeta({ lang: "zh", title: data.title, moral: data.moral });
    // åµæ¸¬[é¸é …]å ä½ç¬¦ï¼šæ ¼å¼ <<A|B>>
    const match = data.story.match(/<<([^>]+)>>/);
    setBranchOpts(match ? match[1].split("|") : []);
    setLoading(false);
  };

  const pickBranch = async (choice: string) => {
    setLoading(true);
    const res = await fetch("/api/branch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ storySoFar: story, choice }),
    });
    const data = await res.json();
    setStory(story + "\n\n" + data.nextPart);
    setBranchOpts([]);
    // çå‹µå¾½ç« ç¯„ä¾‹
    const badges = JSON.parse(localStorage.getItem("badges") || "[]");
    badges.push("ğŸ…");
    localStorage.setItem("badges", JSON.stringify(badges.slice(-5)));
    setLoading(false);
  };

  return (
    <>
      <HeroSection />
      <FeaturesSection />
      <section id="play" className="pt-16 space-y-6">
        {!roles.length ? (
          <RoleScenePanel onReady={(r, s) => { setRoles(r); setScene(s); }} />
        ) : !story ? (
          <GeneratePanel onStory={generateStory} />
        ) : (
          <>
            <StoryMeta story={story} meta={meta} />
            <StoryDisplay story={story} />
            <ChoiceBranch options={branchOpts} onPick={pickBranch} />
          </>
        )}
        {loading && <p className="animate-pulse">è™•ç†ä¸­â€¦</p>}
      </section>
      <AchievementsBar />
    </>
  );
}
```

---
### ä½¿ç”¨æ–¹å¼
1. è§’è‰²Ã—å ´æ™¯ â†’ ä¸‹ä¸€æ­¥
2. é»ã€Œç”Ÿæˆæ•…äº‹ã€â†’ è‹¥ GPT å« `<<å†’éšª|å›å®¶>>` é€™é¡æ¨™è¨˜ï¼Œç•«é¢æœƒé¡¯ç¤ºå…©é¡†æŒ‰éˆ•
3. å°æœ‹å‹é¸æ“‡â†’ `/api/branch` çºŒå¯«ä¸‹ä¸€æ®µ
4. å®Œæˆä¸€æ¬¡åˆ†æ”¯å³é€ä¸€æš ğŸ… å¾½ç« ï¼ˆç¤ºç¯„ç”¨ï¼‰

ğŸŒŸ **Pull â†’ test â†’ push â†’ Vercel**ï¼Œå³å¯é«”é©—ç°¡æ˜“äº’å‹•åˆ†æ”¯èˆ‡æˆå°±ï¼
